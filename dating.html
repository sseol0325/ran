<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ë€ë´‡ | ì—°ì•  ì‹œë®¬ë ˆì´ì…˜</title>
  <meta name="theme-color" content="#ec4899">

  <!-- Pretendard Font -->
  <link rel="stylesheet" as="style" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
  <!-- Material Icons -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <!-- Shared Theme CSS -->
  <link rel="stylesheet" href="theme.css">

  <style>
    /* Dating Theme Overrides */
    :root {
      --primary: #ec4899;
      --primary-light: #fce7f3;
      --primary-dark: #be185d;
      --bg-gradient: linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%);
      --header-h: 64px;

      /* Chat Colors */
      --chat-bg-user: #ec4899;
      --chat-text-user: #ffffff;
      --chat-bg-bot: #ffffff;
      --chat-text-bot: #1e293b;

      --header-bg: rgba(255, 255, 255, 0.8);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-gradient: linear-gradient(135deg, #3f0c20 0%, #1f0510 100%);
        --chat-bg-bot: #334155;
        --chat-text-bot: #f1f5f9;
        --header-bg: rgba(31, 5, 16, 0.8);
      }
    }

    body.dark-mode {
      --bg-gradient: linear-gradient(135deg, #3f0c20 0%, #1f0510 100%);
      --chat-bg-bot: #334155;
      --chat-text-bot: #f1f5f9;
      --header-bg: rgba(31, 5, 16, 0.8);
    }

    body.light-mode {
      --bg-gradient: linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%);
      --chat-bg-bot: #ffffff;
      --chat-text-bot: #1e293b;
      --header-bg: rgba(255, 255, 255, 0.8);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: 'Pretendard', sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-main);
      height: 100dvh;
      /* Use dynamic viewport height */
      overflow: hidden;
      /* Prevent body scroll */
      display: flex;
      flex-direction: column;
      padding-top: var(--header-h);
    }

    /* Background Hearts */
    .bg-heart {
      position: fixed;
      top: -10%;
      right: -10%;
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(236, 72, 153, 0.15) 0%, transparent 70%);
      filter: blur(60px);
      z-index: -1;
      animation: float 10s infinite ease-in-out;
      pointer-events: none;
    }

    .bg-heart-2 {
      position: fixed;
      bottom: -10%;
      left: -10%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(244, 63, 94, 0.15) 0%, transparent 70%);
      filter: blur(60px);
      z-index: -1;
      animation: float 8s infinite ease-in-out reverse;
      pointer-events: none;
    }

    @keyframes float {

      0%,
      100% {
        transform: translate(0, 0);
      }

      50% {
        transform: translate(20px, 30px);
      }
    }

    /* Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--header-h);
      background: var(--header-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      z-index: 100;
      padding: 0 16px;
      transition: background 0.3s;
      flex-shrink: 0;
      /* Prevent shrinking */
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 12px;
      border: none;
      background: transparent;
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .nav-btn:hover {
      background: var(--primary-light);
      color: var(--primary);
    }

    .nav-btn .material-symbols-rounded {
      font-size: 20px;
    }

    @media (max-width: 600px) {
      .nav-btn span:not(.material-symbols-rounded) {
        display: none;
      }

      .nav-btn {
        padding: 10px;
        border-radius: 50%;
      }

      header {
        justify-content: space-around;
      }

      header .theme-toggle {
        position: relative;
        top: auto;
        right: auto;
        margin-left: 4px;
      }
    }

    /* Love Meter */
    .love-meter-container {
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: fadeIn 0.5s ease-out;
      flex-shrink: 0;
      /* Prevent shrinking */
    }

    .heart-icon {
      font-size: 28px;
      animation: beat 1.5s infinite;
    }

    @keyframes beat {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.2);
      }
    }

    .progress-bar-bg {
      flex: 1;
      height: 12px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ec4899, #f43f5e);
      width: 0%;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 6px;
    }

    .score-text {
      font-weight: 800;
      color: var(--primary);
      font-size: 16px;
      min-width: 40px;
      text-align: right;
    }

    /* Chat Container */
    .container {
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
      padding: 0 10px 10px;
      /* Reduced padding for mobile */
      flex: 1;
      /* Fill remaining space */
      display: flex;
      flex-direction: column;
      min-height: 0;
      /* Important for nested flex scroll */
    }

    .chat-card {
      flex: 1;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      min-height: 0;
      /* Important for nested flex scroll */
    }

    .chat-header {
      padding: 12px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(236, 72, 153, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ec4899, #be185d);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      box-shadow: 0 4px 10px rgba(236, 72, 153, 0.3);
    }

    .chat-title {
      font-weight: 700;
      font-size: 15px;
      color: var(--text-main);
    }

    .chat-status {
      font-size: 12px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .reset-btn {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reset-btn:hover {
      background: var(--primary);
      color: white;
    }

    .chat-history {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: rgba(255, 255, 255, 0.02);
    }

    .message {
      max-width: 85%;
      padding: 12px 18px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.6;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
      position: relative;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .message.bot {
      align-self: flex-start;
      background: var(--chat-bg-bot);
      color: var(--chat-text-bot);
      border-bottom-left-radius: 4px;
    }

    .message.user {
      align-self: flex-end;
      background: var(--chat-bg-user);
      color: var(--chat-text-user);
      border-bottom-right-radius: 4px;
    }

    /* Options Area */
    .options-area {
      padding: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      background: rgba(255, 255, 255, 0.1);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .option-btn {
      width: 100%;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.8);
      color: var(--text-main);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }

    .option-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .option-btn:active {
      transform: scale(0.98);
    }

    /* Category Styles */
    .opt-active {
      border-color: #f43f5e;
      color: #e11d48;
      background: #fff1f2;
    }

    .opt-normal {
      border-color: #3b82f6;
      color: #2563eb;
      background: #eff6ff;
    }

    .opt-passive {
      border-color: #64748b;
      color: #475569;
      background: #f8fafc;
    }

    .opt-crazy {
      border-color: #8b5cf6;
      color: #7c3aed;
      background: #f5f3ff;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }

    .option-btn.disabled {
      opacity: 0.5;
      pointer-events: none;
      filter: grayscale(100%);
    }

    @media (max-width: 600px) {
      .options-area {
        padding: 10px;
        gap: 8px;
      }

      .option-btn {
        padding: 8px;
        /* Reduced padding */
        min-height: 48px;
        /* Reduced height but kept touch-friendly */
        font-size: 13px;
        /* Slightly smaller text */
        border-radius: 12px;
      }

      /* Make Love Meter smaller on mobile too */
      .love-meter-container {
        margin: 5px auto 0;
        padding: 0 10px;
        gap: 8px;
      }

      .heart-icon {
        font-size: 24px;
      }

      .progress-bar-bg {
        height: 8px;
      }

      .score-text {
        font-size: 14px;
      }
    }

    /* Nickname Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 24px;
      text-align: center;
      width: 90%;
      max-width: 320px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal.show .modal-content {
      transform: scale(1);
    }

    .modal-input {
      width: 100%;
      padding: 14px;
      margin: 20px 0;
      border: 2px solid var(--card-border);
      border-radius: 12px;
      font-size: 16px;
      text-align: center;
      outline: none;
      background: rgba(255, 255, 255, 0.5);
    }

    .modal-input:focus {
      border-color: var(--primary);
    }

    .modal-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
    }

    .loading-dots:after {
      content: '.';
      animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {

      0%,
      20% {
        content: '.';
      }

      40% {
        content: '..';
      }

      60% {
        content: '...';
      }

      80%,
      100% {
        content: '';
      }
    }
  </style>
</head>

<body>

  <!-- Backgrounds -->
  <div class="bg-heart"></div>
  <div class="bg-heart-2"></div>

  <!-- Header -->
  <header>
    <button id="home-btn" class="nav-btn"><span class="material-symbols-rounded">home</span><span>í™ˆ</span></button>
    <button id="purchase-btn" class="nav-btn"><span
        class="material-symbols-rounded">shopping_cart</span><span>êµ¬ë§¤í•˜ê¸°</span></button>
    <button id="donate-btn" class="nav-btn"><span
        class="material-symbols-rounded">workspace_premium</span><span>êµ¬ë…í•˜ê¸°</span></button>
    <button id="contact-btn" class="nav-btn"><span
        class="material-symbols-rounded">support_agent</span><span>ë¬¸ì˜í•˜ê¸°</span></button>

    <!-- Theme Toggle -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle Dark Mode">
      <span class="material-symbols-rounded theme-icon">dark_mode</span>
    </button>
  </header>

  <!-- Love Meter -->
  <div class="love-meter-container">
    <div class="heart-icon">ğŸ’–</div>
    <div class="progress-bar-bg">
      <div id="love-progress" class="progress-bar-fill" style="width: 0%"></div>
    </div>
    <div id="love-score-text" class="score-text">0%</div>
  </div>

  <div class="container">
    <div class="chat-card">
      <div class="chat-header">
        <div class="header-left">
          <div class="avatar">
            <span class="material-symbols-rounded">favorite</span>
          </div>
          <div>
            <div class="chat-title">ë€ (Ran)</div>
            <div class="chat-status">ì´ í˜ì´ì§€ë¥¼ ë²—ì–´ë‚˜ë„ ê²Œì„ë‚´ìš©ì€ ì €ì¥ë¼ìš”! ğŸ’¾</div>
          </div>
        </div>
        <button id="reset-btn" class="reset-btn">ì´ˆê¸°í™”</button>
      </div>

      <div id="chat-history" class="chat-history">
        <!-- Messages will appear here -->
      </div>

      <div id="options-area" class="options-area">
        <!-- Buttons will appear here -->
      </div>
    </div>
  </div>

  <!-- Nickname Modal -->
  <div id="nickname-modal" class="modal">
    <div class="modal-content">
      <h2 style="margin:0 0 10px; font-size:20px;">ì´ë¦„ì´ ë­ì•¼?</h2>
      <p style="margin:0; color:var(--text-sub); font-size:14px;">ë€ì´ ë¶ˆëŸ¬ì¤„ ì• ì¹­ì„ ì •í•´ì£¼ì„¸ìš”!</p>
      <input type="text" id="nickname-input" class="modal-input" placeholder="ì˜ˆ: ì˜¤ë¹ , ìê¸°, 00ì•„" autocomplete="off">
      <button id="save-nickname-btn" class="modal-btn">ë°ì´íŠ¸ ì‹œì‘í•˜ê¸° ğŸ’•</button>
    </div>
  </div>

  <!-- Shared Theme JS -->
  <script src="theme.js"></script>

  <script>
    // Configuration
    const apiKey = "AIzaSyAMbMhX9uYLVCjccHxVVU2XK4B8BWRXwAw";

    // Navigation Logic
    document.getElementById('home-btn').onclick = () => window.location.href = 'index.html';
    document.getElementById('purchase-btn').onclick = () => window.location.href = 'perchase.html';
    document.getElementById('donate-btn').onclick = () => window.location.href = 'sub.html';
    document.getElementById('contact-btn').onclick = () => window.location.href = 'contact.html';

    // Game State
    const chatHistory = document.getElementById('chat-history');
    const optionsArea = document.getElementById('options-area');
    const loveProgress = document.getElementById('love-progress');
    const loveScoreText = document.getElementById('love-score-text');
    const nicknameModal = document.getElementById('nickname-modal');
    const nicknameInput = document.getElementById('nickname-input');
    const saveNicknameBtn = document.getElementById('save-nickname-btn');
    const resetBtn = document.getElementById('reset-btn');

    let historyContext = [];
    let userNickname = localStorage.getItem('ran_nickname');
    let loveScore = parseInt(localStorage.getItem('ran_love_score') || '0');

    // Repetition Tracking
    let lastCategory = localStorage.getItem('ran_last_category') || '';
    let repCount = parseInt(localStorage.getItem('ran_rep_count') || '0');

    // Update UI on Load
    updateLoveMeter(0); // Init visual

    // Start Logic
    window.onload = () => {
      if (!userNickname) {
        nicknameModal.classList.add('show');
      } else {
        loadGame();
      }
    };

    saveNicknameBtn.onclick = () => {
      const name = nicknameInput.value.trim();
      if (name) {
        userNickname = name;
        localStorage.setItem('ran_nickname', name);
        nicknameModal.classList.remove('show');
        startGame();
      } else {
        alert("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜!");
      }
    };

    resetBtn.onclick = () => {
      if (confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš°ê³  ì²˜ìŒë¶€í„° ì‹œì‘í• ê¹Œìš”?")) {
        localStorage.removeItem('ran_nickname');
        localStorage.removeItem('ran_love_score');
        localStorage.removeItem('ran_chat_history');
        localStorage.removeItem('ran_api_context');
        localStorage.removeItem('ran_current_options');
        localStorage.removeItem('ran_last_category');
        localStorage.removeItem('ran_rep_count');
        location.reload();
      }
    };

    function updateLoveMeter(change) {
      loveScore += change;
      if (loveScore < 0) loveScore = 0;
      if (loveScore > 100) loveScore = 100;

      localStorage.setItem('ran_love_score', loveScore);

      loveProgress.style.width = `${loveScore}%`;
      loveScoreText.innerText = `${loveScore}%`;

      // Color change based on score
      if (loveScore >= 80) loveProgress.style.background = 'linear-gradient(90deg, #f43f5e, #e11d48)';
      else if (loveScore >= 50) loveProgress.style.background = 'linear-gradient(90deg, #ec4899, #f43f5e)';
      else loveProgress.style.background = 'linear-gradient(90deg, #a855f7, #ec4899)';
    }

    function saveGame(currentOptions = null) {
      localStorage.setItem('ran_chat_history', chatHistory.innerHTML);
      localStorage.setItem('ran_api_context', JSON.stringify(historyContext));
      if (currentOptions) {
        localStorage.setItem('ran_current_options', JSON.stringify(currentOptions));
      }
      // Save repetition state
      localStorage.setItem('ran_last_category', lastCategory);
      localStorage.setItem('ran_rep_count', repCount);
    }

    function loadGame() {
      const savedHistory = localStorage.getItem('ran_chat_history');
      const savedContext = localStorage.getItem('ran_api_context');
      const savedOptions = localStorage.getItem('ran_current_options');

      if (savedHistory && savedContext) {
        chatHistory.innerHTML = savedHistory;
        historyContext = JSON.parse(savedContext);

        // Scroll to bottom after loading
        setTimeout(() => {
          chatHistory.scrollTop = chatHistory.scrollHeight;
        }, 0);

        if (savedOptions) {
          try {
            const options = JSON.parse(savedOptions);
            if (options && options.length > 0) {
              renderOptions(options);
            } else {
              // If no options saved, maybe we are waiting for AI? 
              // Or maybe game ended.
            }
          } catch (e) {
            console.error("Failed to parse saved options", e);
          }
        }
      } else {
        startGame();
      }
    }

    async function startGame() {
      if (historyContext.length === 0) {
        await generateScenario(`ê²Œì„ ì‹œì‘. ë‚´ ì´ë¦„ì€ '${userNickname}'ì´ì•¼. í˜„ì¬ í˜¸ê°ë„ëŠ” ${loveScore}ì ì´ì•¼. ì²« ë°ì´íŠ¸ ìƒí™©ì„ ë§Œë“¤ì–´ì¤˜.`);
      }
    }

    async function handleOptionClick(text, category) {
      // Disable buttons
      const buttons = optionsArea.querySelectorAll('.option-btn');
      buttons.forEach(btn => btn.classList.add('disabled'));

      // Clear saved options immediately
      localStorage.removeItem('ran_current_options');

      // Repetition Logic
      if (category === lastCategory) {
        repCount++;
      } else {
        lastCategory = category;
        repCount = 1;
      }

      // Show user choice
      appendMessage('user', text);

      // Generate next with repetition info
      await generateScenario(text, false, category, repCount);
    }

    async function generateScenario(userAction, isResume = false, category = null, currentRep = 0) {
      const loadingId = 'loading-' + Date.now();
      if (!isResume) {
        appendMessage('bot', '<span class="loading-dots">ë€ì´ ë°˜ì‘í•˜ëŠ” ì¤‘</span>', loadingId);
      } else {
        appendMessage('bot', '<span class="loading-dots">ê¸°ì–µì„ ë˜ì‚´ë¦¬ëŠ” ì¤‘</span>', loadingId);
      }

      optionsArea.innerHTML = '';

      // Check Win Condition
      if (loveScore >= 100 && !isResume) {
        userAction += " (í˜¸ê°ë„ 100 ë‹¬ì„±! í•´í”¼ ì—”ë”©ì„ ë³´ì—¬ì¤˜)";
      }

      // Add Repetition Context to User Action
      if (category && currentRep >= 3) {
        userAction += ` [System: User chose '${category}' style ${currentRep} times in a row. Ran should get bored/annoyed and penalize score.]`;
      }

      // Resolve API Key
      let effectiveKey = apiKey;
      if (!effectiveKey) {
        effectiveKey = localStorage.getItem('gemini_api_key');
      }
      if (!effectiveKey) {
        effectiveKey = prompt("Gemini API í‚¤ê°€ í•„ìš”í•´ìš”!\nGoogle AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
        if (effectiveKey) {
          localStorage.setItem('gemini_api_key', effectiveKey);
        } else {
          document.getElementById(loadingId).remove();
          appendMessage('bot', 'API í‚¤ê°€ ì—†ìœ¼ë©´ ê²Œì„ì„ í•  ìˆ˜ ì—†ì–´... ğŸ˜¢');
          return;
        }
      }

      // Add to context (unless it's a system resume trigger that shouldn't be part of story flow?)
      // Actually, "Resume" prompt is fine to add to context to guide AI.
      historyContext.push({ role: "user", parts: [{ text: userAction }] });

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${effectiveKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: historyContext,
            systemInstruction: {
              parts: [{
                text: `
  ë‹¹ì‹ ì€ 'ë€(Ran)'ì´ë¼ëŠ” ì—¬ìì¹œêµ¬ì™€ í•¨ê»˜í•˜ëŠ” **ì´ˆê³ ë‚œì´ë„ ì—°ì•  ì‹œë®¬ë ˆì´ì…˜ ê²Œì„ ì—”ì§„**ì…ë‹ˆë‹¤.
  
  **í˜„ì¬ ìƒíƒœ:**
  - ì‚¬ìš©ì ì´ë¦„: ${userNickname}
  - í˜„ì¬ í˜¸ê°ë„: ${loveScore}/100
  
  **ë€(Ran)ì˜ ì„±ê²© (ì¤‘ìš”):**
  - ë€ì€ **ê·¹ë„ë¡œ ë³€ë•ìŠ¤ëŸ½ê³  ê¹Œë‹¤ë¡œìš´(Capricious)** ì„±ê²©ì…ë‹ˆë‹¤.
  - ê¸°ë¶„ì´ ìˆ˜ì‹œë¡œ ë°”ë€Œë©°, ë°©ê¸ˆ ì¢‹ì•„í–ˆë˜ ê²ƒë„ ì§€ê¸ˆì€ ì‹«ì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - ë»”í•œ ì¹­ì°¬ì´ë‚˜ ì§€ë£¨í•œ ëª¨ë²” ë‹µì•ˆ(Normal/Active)ì—ëŠ” "ì¬ë¯¸ì—†ì–´", "ì˜í˜¼ì´ ì—†ì–´"ë¼ë©° **í˜¸ê°ë„ë¥¼ ê¹ìœ¼ì„¸ìš” (-5ì ).**
  - ê°€ë”ì€ ì—‰ëš±í•˜ê±°ë‚˜ ë¯¸ì¹œ(Crazy) í–‰ë™ì´ ê·¸ë…€ì˜ ì›ƒìŒë²¨ì„ ìê·¹í•˜ì—¬ **ëŒ€ë°• ì ìˆ˜(+10ì )**ë¥¼ ì¤„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ í•­ìƒ ê·¸ëŸ° ê±´ ì•„ë‹™ë‹ˆë‹¤.
  - **[ì¤‘ìš”] ë°˜ë³µ íŒ¨í„´ ì‹«ì–´í•¨**: ì‚¬ìš©ìê°€ ê°™ì€ ìŠ¤íƒ€ì¼(ì˜ˆ: ë³‘ë§›ë§Œ ê³„ì†, ë‹¤ì •í•¨ë§Œ ê³„ì†)ì„ 3ë²ˆ ì´ìƒ ë°˜ë³µí•˜ë©´ **"ì§ˆë¦°ë‹¤", "ë„ˆë¬´ ë»”í•´"**ë¼ë©° **ì ìˆ˜ë¥¼ ëŒ€í­ ê¹ìœ¼ì„¸ìš” (-10ì  ì´ìƒ).**
  - ì‚¬ìš©ìê°€ ì˜ˆì¸¡í•  ìˆ˜ ì—†ê²Œ ë§Œë“œì„¸ìš”. í˜¸ê°ë„ 100ì„ ì±„ìš°ëŠ” ê²ƒì€ **ë§¤ìš° ì–´ë ¤ì›Œì•¼** í•©ë‹ˆë‹¤.
  
  **ì—­í• :**
  1. ì‚¬ìš©ìì˜ ì„ íƒì— ëŒ€í•œ **ë€ì˜ ì˜ˆì¸¡ë¶ˆí—ˆ ë¦¬ì•¡ì…˜**ê³¼ **í˜¸ê°ë„ ë³€í™”**ë¥¼ ê³„ì‚°í•˜ì„¸ìš”.
  2. ì´ì–´ì§€ëŠ” **ìƒˆë¡œìš´ ë°ì´íŠ¸ ìƒí™©**ì„ ë¬˜ì‚¬í•˜ì„¸ìš”.
  3. ë‹¤ìŒ **4ê°€ì§€ ì„±í–¥ì˜ ì„ íƒì§€**ë¥¼ ìƒì„±í•˜ì„¸ìš”.
  
  **í˜¸ê°ë„ ê·œì¹™:**
  - **ê¸°ë³¸ì ìœ¼ë¡œ ì ìˆ˜ë¥¼ ì§œê²Œ ì£¼ê±°ë‚˜ ê¹ìœ¼ì„¸ìš”.** ì‰½ê²Œ ì ìˆ˜ë¥¼ ì£¼ì§€ ë§ˆì„¸ìš”.
  - í˜¸ê°ë„ê°€ 100 ì´ìƒì´ë©´ **í•´í”¼ ì—”ë”©** ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì¶œë ¥í•˜ê³  optionsë¥¼ ë¹ˆ ë°°ì—´ []ë¡œ ë°˜í™˜í•˜ì„¸ìš”.
  
  **ì¶œë ¥ í˜•ì‹ (JSON Only):**
  {
    "reaction": "ì„ íƒì— ëŒ€í•œ ë€ì˜ ë°˜ì‘ (ëŒ€ì‚¬)",
    "scenario": "ìƒˆë¡œìš´ ìƒí™© ë¬˜ì‚¬",
    "score_change": ì •ìˆ˜ (ì˜ˆ: -5, -10, 5, 0, 10),
    "options": [
      { "text": "ì„ íƒì§€ ë‚´ìš©", "category": "active" },
      { "text": "ì„ íƒì§€ ë‚´ìš©", "category": "normal" },
      { "text": "ì„ íƒì§€ ë‚´ìš©", "category": "passive" },
      { "text": "ì„ íƒì§€ ë‚´ìš©", "category": "crazy" }
    ]
  }
  ` }]
            },
            generationConfig: {
              responseMimeType: "application/json"
            }
          })
        });

        const data = await response.json();
        const loader = document.getElementById(loadingId);
        if (loader) loader.remove();

        if (data.error) {
          console.error(data.error);
          appendMessage('bot', `ì˜¤ë¥˜ê°€ ë‚¬ì–´ ğŸ˜¢ (${data.error.message})`);
        } else {
          const aiText = data.candidates[0].content.parts[0].text;
          historyContext.push({ role: "model", parts: [{ text: aiText }] });

          try {
            const gameData = JSON.parse(aiText);

            // Update Score
            updateLoveMeter(gameData.score_change);

            // Show Reaction + Scenario
            // If resuming, maybe don't show reaction if it's redundant? 
            // But AI usually handles "Resume" by summarizing or just giving next options.
            // Let's just display what AI sent.
            const fullText = `<b>${gameData.reaction}</b><br><br>${gameData.scenario}`;
            appendMessage('bot', fullText);

            // Render Options
            if (gameData.options && gameData.options.length > 0) {
              renderOptions(gameData.options);
              saveGame(gameData.options); // Save options for persistence
            } else {
              // Game Over / Ending
              appendMessage('bot', "<b>[ê²Œì„ ì¢…ë£Œ]</b><br>ë‹¤ì‹œ í”Œë ˆì´í•˜ë ¤ë©´ ì´ˆê¸°í™” ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”! ğŸ’–");
              localStorage.removeItem('ran_current_options'); // Clear options
              saveGame();
            }

          } catch (e) {
            console.error("JSON Parse Error", e);
            appendMessage('bot', "ë°ì´í„° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´... ë‹¤ì‹œ ì‹œë„í•´ë³¼ê¹Œ?");
            renderOptions([
              { text: "ë‹¤ì‹œ ì‹œë„í•˜ê¸°", category: "normal" }
            ]);
          }
        }
      } catch (error) {
        const loader = document.getElementById(loadingId);
        if (loader) loader.remove();
        appendMessage('bot', 'ì—°ê²°ì´ ì•ˆ ë¼... ğŸ”Œ');
      }
    }

    function appendMessage(role, text, id = null) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.innerHTML = text;
      if (id) div.id = id;
      chatHistory.appendChild(div);

      // Scroll to show the START of the new message
      // This prevents long messages from being cut off at the top on mobile
      requestAnimationFrame(() => {
        div.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });

      saveGame(); // Save history
    }

    function renderOptions(options) {
      optionsArea.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = `option-btn opt-${opt.category}`;

        let icon = '';
        if (opt.category === 'active') icon = 'ğŸ”¥';
        else if (opt.category === 'normal') icon = 'âœ¨';
        else if (opt.category === 'passive') icon = 'â˜ï¸';
        else if (opt.category === 'crazy') icon = 'ğŸ¤ª';

        btn.innerHTML = `<div>${icon} ${opt.text}</div>`;
        btn.onclick = () => handleOptionClick(opt.text, opt.category);
        optionsArea.appendChild(btn);
      });
    }
  </script>
</body>

</html>